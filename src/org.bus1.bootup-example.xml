<?xml version='1.0'?> <!--*-nxml-*-->
<!DOCTYPE refentry PUBLIC "-//OASIS//DTD DocBook XML V4.2//EN"
  "http://www.oasis-open.org/docbook/xml/4.2/docbookx.dtd">

<!--
  This file is part of bus1. See COPYING for details.

  bus1 is free software; you can redistribute it and/or modify it
  under the terms of the GNU Lesser General Public License as published by
  the Free Software Foundation; either version 2.1 of the License, or
  (at your option) any later version.

  bus1 is distributed in the hope that it will be useful, but
  WITHOUT ANY WARRANTY; without even the implied warranty of
  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU
  Lesser General Public License for more details.

  You should have received a copy of the GNU Lesser General Public License
  along with bus1; If not, see <http://www.gnu.org/licenses/>.
-->

<refentry id="org.bus1.bootup-example">
  <refmeta>
    <refentrytitle>org.bus1.bootup-example</refentrytitle>
    <manvolnum>7</manvolnum>
  </refmeta>

  <refnamediv>
    <refname>org.bus1.bootup-example</refname>
    <refpurpose>Bootup</refpurpose>
  </refnamediv>

  <refsect1>
    <title>A running bus1 system.</title>

<screen>
# download and install /usr tree
$ sudo make efi

# build a UEFI bootable disk image and run it with QEMU (needs QEMU UEFI firmware image):
$ sudo make test-efi

# run the kernel and initrd directly in QEMU:
$ sudo make test-qemu
/usr/bin/qemu-system-x86_64 -machine accel=kvm -m 1024 -kernel vmlinuz -initrd initrd -serial stdio \
	-append "quiet disk=$(blkid -p -s PTUUID -o value efi-disk.img) loader=/EFI/org.bus1/$(cat system/usr/lib/org.bus1/release).efi console=ttyS0 console=tty0" \
	-drive format=raw,file=efi-disk.img

Fedora 25 (Rawhide)
Kernel 4.6.0-0.rc0.git12.1.fc25.x86_64 on an x86_64 (ttyS0)

login: root

-bash-4.3# dmesg | grep bus1
[    0.000000] Command line: quiet disk=dafc8a78-5c69-4523-80cb-48600bd37cc3 loader=/EFI/org.bus1/org.example-1458529446.efi console=ttyS0 console=tty0
[    0.700681] bus1: initialized
[    0.703969] org.bus1.rdinit[1]: Starting org.bus1.activator.
[    0.705730] org.bus1.activator[94]: Activating service org.bus1.devices.
[    0.706876] org.bus1.devices[94]: Coldplug, adjust /dev permissions and load kernel modules for current devices.
[    0.806583] org.bus1.rdinit[1]: Mounting boot device /dev/sda1 at /boot.
[    0.818367] org.bus1.rdinit[1]: Setting up cryptographic integrity validation of system image org.example-1458529446.img.
[    0.829313] org.bus1.rdinit[1]: Mounting /dev/dm-0 (squashfs) at /usr.
[    0.901770] org.bus1.rdinit[1]: Setting up decryption of data volume /dev/sda2.
[    0.919727] org.bus1.rdinit[1]: Mounting org.bus1.disk.data device /dev/dm-1 (xfs) at /var.
[    1.013022] org.bus1.activator[93]: Terminating service org.bus1.devices.
[    1.023692] org.bus1.rdinit[1]: Executing org.bus1.init.
[    1.076806] org.bus1.init[1]: Release org.example-1458529446.
[    1.076928] org.bus1.init[1]: Starting org.bus1.administrator.
[    1.077057] org.bus1.init[1]: Starting org.bus1.activator.
[    1.081872] org.bus1.activator[178]: Activating service org.bus1.devices.
[    1.091723] org.bus1.administrator[176]: Starting getty on tty1.
[    1.091862] org.bus1.administrator[176]: Starting getty on ttyS0.
[    1.138581] org.bus1.devices[178]: Coldplug, adjust /dev permissions and load kernel modules for current devices.

-bash-4.3# ps afx
    1 ?        Ss     0:00 /usr/bin/org.bus1.init
  176 ?        Ss     0:00 /usr/bin/org.bus1.administrator
  179 ?        Ss     0:00  \_ login -- root
  258 tty1     Ss+    0:00  |   \_ -bash
  180 ?        Ss     0:00  \_ login -- root
  237 ttyS0    Ss     0:00      \_ -bash
  275 ttyS0    R+     0:00          \_ ps afx
  177 ?        Ss     0:00 /usr/bin/org.bus1.activator
  178 ?        Ss     0:00  \_ /usr/bin/org.bus1.devices

-bash-4.3# findmnt 
TARGET       SOURCE    FSTYPE  OPTIONS
/            tmpfs     tmpfs   rw,nosuid,nodev,noexec,size=5120k,mode=755
|-/dev       devtmpfs  devtmpf rw,nosuid,noexec,size=491896k,nr_inodes=122974,mo
| `-/dev/pts devpts    devpts  rw,nosuid,noexec,relatime,mode=620,ptmxmode=666
|-/proc      proc      proc    rw,nosuid,nodev,noexec,relatime,hidepid=2
|-/sys       sysfs     sysfs   rw,nosuid,nodev,noexec,relatime
|-/boot      /dev/sda1 vfat    rw,nosuid,nodev,noexec,relatime,fmask=0027,dmask=
|-/usr       /dev/dm-0 squashf ro,nodev,relatime
|-/etc       /dev/dm-0[/etc]
|                      squashf ro,nodev,relatime
`-/var       /dev/dm-1 xfs     rw,nosuid,nodev,noexec,relatime,attr2,inode64,noq

-bash-4.3# df -kh
Filesystem      Size  Used Avail Use% Mounted on
devtmpfs        481M     0  481M   0% /dev
tmpfs           5.0M     0  5.0M   0% /
/dev/sda1       510M  193M  317M  38% /boot
/dev/dm-0       178M  178M     0 100% /usr
/dev/dm-1       508M   26M  482M   6% /var

-bash-4.3# tree /boot/
/boot
`-- EFI
    |-- Boot
    |   `-- bootx64.efi
    `-- org.bus1
        |-- org.example-1458529446.efi
        `-- org.example-1458529446.img

-bash-4.3# org.bus1.diskctl info /boot/EFI/org.bus1/org.example-1458529446.img 
==================================================================================
Info for:         /boot/EFI/org.bus1/org.example-1458529446.img
Image type:       org.bus1.disk.sign
Image Name:       org.bus1.disk.system
Image UUID:       d05f7f9a-109a-4ca6-988e-7eba6f60e082
Data type:        squashfs
Data offset:      8192 bytes
Data size:        186019840 bytes
Hash tree offset: 186028032 bytes
Hash tree size:   1470464 bytes
Hash algorithm:   sha256
Hash digest size: 256 bits
Data block size:  4096 bytes (45415 blocks)
Hash Block size:  4096 bytes (359 blocks)
Salt:             5da82ad801a2c755c7796664e97f41e27629643f70ac7afb138c28ebb72e0252
Root hash:        fc3856f7a8d81d02e6b3866e369ae7f3704394990ff04a610dee78a3ca3e0929
==================================================================================

-bash-4.3# org.bus1.diskctl info /dev/sda2
========================================================================================================
Info for:               /dev/sda2
Image type:             org.bus1.disk.encrypt
Image name:             org.bus1.disk.data
Image UUID:             00f8cb18-61c7-499e-9e62-decdfc6656ca
Data type:              xfs
Data offset:            36864 bytes
Data size:              535785472 bytes
Data encryption:        aes-xts-plain64
Master key encryption:  aes-wrap
Master key (encrypted): 927c33e1bab62154d605e23f4801b94a6f270b9b40d5bb3b5573cba9030c795140e9ae2cf8162991
Master key size:        320 bits
Number of key slots:    2
Slot 1:
  type UUID:            54e18c3c-3f65-4909-a536-bf7d080ff282
  UUID:                 6a4c5332-43a7-339c-c961-78d4857eed8a
  type:                 clear
    encryption:         aes-wrap
    key (encrypted):    e24d5309cd2c2f22b4b3840053d17d6b890f009135c5096a15eb14712e7ac7499a6b571d6a6229dd
    key size:           320 bits
Slot 2:
  type UUID:            30a49386-8bbc-4e97-8412-03f50ad10621
  UUID:                 d825e33b-f332-ff01-3879-455c0152ca22
  type:                 recovery
    encryption:         aes-wrap
    key (encrypted):    fa3be30926195ccf9ecf95f33c29d4704f1b68697b11f672d95767305e7c53e35982e344fa247c29
    key size:           320 bits
========================================================================================================

-bash-4.3# 
</screen>
  </refsect1>

  <refsect1>
    <title>See Also</title>
      <para>
        <citerefentry><refentrytitle>org.bus1.init</refentrytitle><manvolnum>1</manvolnum></citerefentry>,
        <ulink url="https://github.com/bus1/base">Git repository</ulink>
      </para>
  </refsect1>
</refentry>
